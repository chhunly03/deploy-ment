name: Deploy & Notify

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      # Make sure these secrets exist in GitHub Settings ‚Üí Secrets and variables ‚Üí Actions
      VERCEL_DEPLOY_HOOK: ${{ secrets.VERCEL_DEPLOY_HOOK }}
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Trigger Vercel Deploy
        id: trigger
        run: |
          if [ -z "${VERCEL_DEPLOY_HOOK}" ]; then
            echo "‚ùå VERCEL_DEPLOY_HOOK is not set. Add it to repo secrets."
            exit 1
          fi

          echo "Triggering Vercel deploy..."
          # Trigger the Vercel deploy hook (this is asynchronous)
          curl -sS -X POST "${VERCEL_DEPLOY_HOOK}" -o /tmp/vercel_response.txt || true
          echo "Vercel response:"
          cat /tmp/vercel_response.txt || true

      - name: Notify Telegram (always)
        if: always()
        run: |
          # Determine job status (success or failure)
          if [ "${{ job.status }}" = "success" ]; then
            STATUS="SUCCESS ‚úÖ"
          else
            STATUS="FAILED ‚ùå"
          fi

          # Branch name cleanup (remove refs/heads/)
          BRANCH="${GITHUB_REF#refs/heads/}"

          # Get last commit message (repo checked out above)
          COMMIT_MSG="$(git log -1 --pretty=%B | tr -d '\r')"

          MESSAGE="üöÄ Pipeline Notification
Status: $STATUS
Repository: ${GITHUB_REPOSITORY}
Branch: $BRANCH
Committer: ${GITHUB_ACTOR}
Commit ID: ${GITHUB_SHA}
Commit Message: $COMMIT_MSG
üîó Workflow Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          echo "Sending Telegram message..."
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown" \
            || echo "‚ùå Failed to send Telegram message"
