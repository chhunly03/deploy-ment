name: deploy

on:
  push:
    branches:
      - main

jobs:
  notify-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Notify Telegram (push)
        run: |
          COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          MESSAGE: |
            üìå Code pushed by *${GITHUB_ACTOR}*
            Repository: *${GITHUB_REPOSITORY}*
            Branch: *${GITHUB_REF_NAME}*
            Commit message: _${COMMIT_MESSAGE}_
          curl -s -X POST \"https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage\" \
            -d chat_id=\"${{ secrets.TELEGRAM_CHAT_ID }}\" \
            -d text=\"$MESSAGE\" \
            -d parse_mode=\"Markdown\"

  deploy:
    runs-on: ubuntu-latest
    needs: notify-push
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Vercel
        run: |
          if [ -z "$VERCEL_DEPLOY_HOOK" ]; then
            echo "‚ùå ERROR: VERCEL_DEPLOY_HOOK is not set. Please add it as a repository secret."
            exit 1
          fi
          RESPONSE=$(curl -s -X POST "$VERCEL_DEPLOY_HOOK")
          echo "Deploy response: $RESPONSE"
        env:
          VERCEL_DEPLOY_HOOK: ${{ secrets.VERCEL_DEPLOY_HOOK }}

  notify-result:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Notify Telegram (success/failure)
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            STATUS="SUCCESS ‚úÖ"
            RELEASE_STATUS="deployed"
          else
            STATUS="FAILURE ‚ùå"
            RELEASE_STATUS="failed"
          fi
          APP_NAME="$(basename ${GITHUB_REPOSITORY})"
          RELEASE_NAME="${APP_NAME}-dev-release"
          LAST_DEPLOYED="$(date '+%a %b %d %H:%M:%S %Y')"
          NAMESPACE="api-dev"
          ENVIRONMENT="dev"
          REVISION="117"
          VERSION="dev-v0.2.77"
          BUILD_URL="http://10.11.20.249:8080/job/acleda-api/job/qrt_payment/278/"
          MESSAGE: |
            üöÄ Pipeline Notification
            Status: ${STATUS}
            Namespace: ${NAMESPACE}
            Application: ${APP_NAME}
            Environment: ${ENVIRONMENT}
            Release Name: ${RELEASE_NAME}
            Last Deployed: ${LAST_DEPLOYED}
            Release Status: ${RELEASE_STATUS}
            Revision: ${REVISION}
            Version: ${VERSION}
            Branch: origin/${GITHUB_REF_NAME}
            Committer: ${GITHUB_ACTOR}
            Commit ID: ${GITHUB_SHA}
            üîó View Build Details (${BUILD_URL})
          curl -s -X POST \"https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage\" \
            -d chat_id=\"${{ secrets.TELEGRAM_CHAT_ID }}\" \
            -d text=\"$MESSAGE\" \
            -d parse_mode=\"Markdown\"